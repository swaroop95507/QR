<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Scan - SoftExpert</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    select, input, button {
      width: 90%;
      max-width: 400px;
      margin: 8px;
      padding: 10px;
      font-size: 1rem;
    }

    #qr-reader {
      width: 100%;
      max-width: 400px;
      height: auto;
      position: relative;
      margin-bottom: 10px;
      display: none;
      border-radius: 10px;
      overflow: hidden;
    }

    .scan-box {
      position: absolute;
      top: 30%;
      left: 25%;
      width: 50%;
      height: 30%;
      border: 3px solid limegreen;
      z-index: 2;
      pointer-events: none;
    }

    #scannedCode {
      font-weight: bold;
      text-align: center;
      border: 2px solid #999;
      background: white;
    }

    #scannedCode.valid {
      border-color: green;
      background-color: #e0ffe0;
    }

    #scannedCode.invalid {
      border-color: red;
      background-color: #ffe0e0;
    }

    form {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 420px;
    }

    @media screen and (max-width: 500px) {
      #qr-reader {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <h2>Scan Label ‚Üí Submit to SoftExpert</h2>

  <!-- Mode Switch -->
  <select id="modeSelect" onchange="toggleMode()">
    <option value="camera">üì∑ Camera Mode</option>
    <option value="manual">‚å®Ô∏è Manual Mode</option>
  </select>

  <!-- Camera Display -->
  <div id="qr-reader">
    <div class="scan-box"></div>
  </div>

  <!-- Unified Scan Field (Manual + Camera) -->
  <input type="text" id="scannedCode" placeholder="Scanned QR Code..." oninput="manualScan()" readonly />

  <!-- Output Fields -->
  <form id="dataForm">
    <input type="text" id="partNumber" placeholder="Part Number" required />
    <input type="text" id="lotNumber" placeholder="Lot Number" required />
    <input type="text" id="quantity" placeholder="Quantity" required />
    <button type="submit">Submit to SoftExpert</button>
  </form>

  <script>
    let qrScanner;
    let lastScan = "";

    function fillFromText(qr) {
      const scannedField = document.getElementById("scannedCode");
      scannedField.value = qr;

      const parts = qr.split("|");
      const isValid = parts.length >= 6;

      scannedField.classList.remove("valid", "invalid");
      scannedField.classList.add(isValid ? "valid" : "invalid");

      if (isValid) {
        document.getElementById("partNumber").value = parts[0].trim();
        document.getElementById("quantity").value = parts[3].trim();
        document.getElementById("lotNumber").value = parts[5].trim();
      } else {
        document.getElementById("partNumber").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("lotNumber").value = "";
      }
    }

    function manualScan() {
      const text = document.getElementById("scannedCode").value;
      if (text.includes("|")) {
        fillFromText(text);
      }
    }

    function startCamera() {
      const reader = document.getElementById("qr-reader");
      reader.style.display = "block";

      qrScanner = new Html5Qrcode("qr-reader");
      qrScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 280, height: 180 }
        },
        (decodedText) => {
          if (decodedText !== lastScan) {
            lastScan = decodedText;
            fillFromText(decodedText);
          }
        },
        error => { /* silently ignore */ }
      ).catch(err => alert("Camera error: " + err));
    }

    function stopCamera() {
      const reader = document.getElementById("qr-reader");
      reader.style.display = "none";
      if (qrScanner) {
        qrScanner.stop().then(() => qrScanner.clear()).catch(() => {});
      }
    }

    function toggleMode() {
      const mode = document.getElementById("modeSelect").value;
      const scannedCode = document.getElementById("scannedCode");

      if (mode === "camera") {
        scannedCode.readOnly = true;
        startCamera();
      } else {
        scannedCode.readOnly = false;
        stopCamera();
        scannedCode.focus();
      }

      scannedCode.value = "";
      scannedCode.classList.remove("valid", "invalid");
      document.getElementById("dataForm").reset();
    }

    document.getElementById("dataForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const payload = {
        partNumber: document.getElementById("partNumber").value,
        lotNumber: document.getElementById("lotNumber").value,
        quantity: document.getElementById("quantity").value
      };

      fetch("https://yorozu.softexpert.com/apigateway/v1/table/YOUR_TABLE_ID/record", {
        method: "POST",
        headers: {
          "Authorization": "Bearer YOUR_API_TOKEN",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (!res.ok) throw new Error("Submission failed");
        return res.json();
      })
      .then(data => {
        alert("‚úÖ Submitted!");
        document.getElementById("dataForm").reset();
        document.getElementById("scannedCode").value = "";
        document.getElementById("scannedCode").classList.remove("valid", "invalid");
        lastScan = "";
      })
      .catch(err => alert("‚ùå Error: " + err.message));
    });

    window.onload = toggleMode;
  </script>

</body>
</html>
